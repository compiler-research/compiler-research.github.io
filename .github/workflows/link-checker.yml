name: Broken link check

on:
  pull_request:

jobs:
  broken_link_checker_job:
    runs-on: ubuntu-latest
    name: Check for broken links
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for broken links using wget
        run: |
          echo "Checking links on https://compiler-research.org/ ..."
          # Get all hrefs from the homepage
          LINKS=$(curl -s https://compiler-research.org/ | grep -Eo 'href="[^"]+"' | cut -d'"' -f2)
          
          BROKEN=0
          for link in $LINKS; do
            # Skip empty links and anchors
            if [[ -z "$link" || "$link" == \#* ]]; then
              continue
            fi
            # Skip ignored patterns
            if [[ "$link" == *"github"* || "$link" == *"google"* ]]; then
              continue
            fi
            # Make request and get HTTP status
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$link" || echo "000")
            if [[ "$STATUS" -ge 400 || "$STATUS" == "000" ]]; then
              echo "BROKEN: $link -> $STATUS"
              BROKEN=$((BROKEN+1))
            fi
          done

          if [[ $BROKEN -gt 0 ]]; then
            echo "$BROKEN broken link(s) found."
            exit 1
          else
            echo "No broken links found."
          fi
