{% comment %} 1. Collect all tags {% endcomment %}
{% assign all_tags = "" | split: "," %}
{% for item in include.items %}
  {% if item.tags %}
    {% for tag in item.tags %}
      {% assign all_tags = all_tags | push: tag %}
    {% endfor %}
  {% endif %}
{% endfor %}

{% comment %} 2. Count and format for sorting {% endcomment %}
{% assign unique_tags = all_tags | uniq %}
{% assign tag_counts_string = "" %}

{% for tag in unique_tags %}
  {% assign count = 0 %}
  {% for t in all_tags %}
    {% if t == tag %}{% assign count = count | plus: 1 %}{% endif %}
  {% endfor %}

  {% comment %} Create a long string separated by ':::' {% endcomment %}
  {% assign count_padded = count | prepend: "0000" | slice: -4, 4 %}
  {% assign entry = count_padded | append: "|" | append: tag %}
  {% assign tag_counts_string = tag_counts_string | append: entry | append: ":::" %}
{% endfor %}

{% comment %} 3. Convert string to Array and then Sort {% endcomment %}
{% assign sorted_tag_counts = tag_counts_string | split: ":::" | sort | reverse %}

<div class="filter-widget" markdown="0">
  <div class="filter-search-row">
    <input type="text" id="search-input" placeholder="Search..." onkeyup="updateFilters()">
    <button id="clear-filters" onclick="resetFilters()">Clear</button>
  </div>

  <div class="filter-tag-row">
  <span class="filter-label">{{ include.label }}:</span>

  {% comment %} Set your threshold here: tags with count < threshold are hidden {% endcomment %}
  {% assign threshold = 2 %}
  {% assign has_extra = false %}

  <button class="filter-btn" onclick="applyTagFilter('all')">
    All <span class="count-pill">{{ include.items.size }}</span>
  </button>

  {% for entry in sorted_tag_counts %}
    {% assign parts = entry | split: "|" %}
    {% assign tag = parts[1] %}
    {% assign count = parts[0] | plus: 0 %}

    {% if tag != "" %}
      {% if count >= threshold %}
        <button class="filter-btn" onclick="applyTagFilter('{{ tag }}')">
          {{ tag }} <span class="count-pill">{{ count }}</span>
        </button>
      {% else %}
        {% if has_extra == false %}
          <span id="extra-tag-container" class="is-hidden" style="display: contents;">
          {% assign has_extra = true %}
        {% endif %}
        <button class="filter-btn" onclick="applyTagFilter('{{ tag }}')">
          {{ tag }} <span class="count-pill">{{ count }}</span>
        </button>
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if has_extra %}
    </span> <button id="toggle-more-btn" class="filter-btn" onclick="toggleExtraTags()" style="border-style: dashed; opacity: 0.7;">
      + More
    </button>
  {% endif %}
  </div>

  <div id="no-results" class="no-results-message is-hidden">
    Please select a tag to view items.
  </div>
</div>

<style>
  /* --- Core Layout (Global) --- */
.filterable-list .filter-item.well {
  display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  gap: 24px;
  align-items: flex-start;
}

.filterable-list .post-content {
  flex: 1;
  min-width: 0;
}

.filterable-list .thumbnail-container {
  flex: 0 0 200px;
}

.filterable-list .thumbnail-image {
  width: 200px;
  height: 200px;
  object-fit: cover;
  border-radius: 4px;
}

/* --- The Tag Badges --- */
.tag-badge {
  display: inline-block;
  background: #004b87;
  color: white;
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 0.75em;
  cursor: pointer;
  border: none;
  transition: opacity 0.2s;
}

.tag-badge:hover { opacity: 0.8; }

/* The only acceptable !important to ensure JS override works */
.is-hidden { display: none !important; }

/* --- Responsive Stacking --- */
@media (max-width: 768px) {
  .filterable-list .filter-item.well { flex-direction: column-reverse; }
  .filterable-list .thumbnail-container { width: 100%; flex-basis: auto; }
  .filterable-list .thumbnail-image { width: 100%; height: auto; max-height: 250px; }
}

.filter-widget {
    margin: 20px 0;
    padding: 1.5rem;
    background: #fcfcfc;
    border: 1px solid #e1e4e8;
    border-radius: 8px;
  }
  .filter-search-row { display: flex; gap: 10px; margin-bottom: 1rem; }
  .filter-search-row input { flex: 1; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; }
  .filter-tag-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
  .filter-label { font-weight: bold; font-size: 0.9em; color: #555; }

  .filter-btn {
    background: white;
    border: 1px solid #004b87;
    color: #004b87;
    padding: 4px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    display: inline-flex;
    align-items: center;
  }
  .filter-btn.active { background: #004b87; color: white; }
  .count-pill { background: rgba(0,0,0,0.08); padding: 1px 6px; border-radius: 10px; margin-left: 8px; font-size: 0.8em; }
  .filter-btn.active .count-pill { background: rgba(255,255,255,0.2); }

  .no-results-message {
    margin: 20px 0;
    padding: 2rem;
    text-align: center;
    background: #fff9e6; /* Light amber background */
    border: 1px solid #ffe58f; /* Subtle border */
    border-radius: 8px;
    color: #856404; /* Darker amber text */
    font-weight: bold;
    font-size: 1.1em;
  }
  /* Ensure this is at the bottom of your style block */
  .is-hidden { display: none !important; }
</style>

<script>
/** 1. On Load: Set state from URL and run filter **/
document.addEventListener('DOMContentLoaded', function() {
  const params = new URLSearchParams(window.location.search);
  window.currentTag = params.get('tag'); // No fallback here ensures empty if missing

  const searchInput = document.getElementById('search-input');
  if (searchInput) searchInput.value = params.get('q') || '';

  window.updateFilters(false); // Initial run
});

/** 2. Click Handler **/
window.applyTagFilter = function(tag) {
  window.currentTag = tag;
  window.updateFilters(true);
};

/** 3. Core Logic: URL Sync + Visibility + No Results Message **/
window.updateFilters = function(updateUrl = true) {
  const q = document.getElementById('search-input').value || '';
  const qLower = q.toLowerCase();

  // Sync Address Bar
  if (updateUrl) {
    const url = new URL(window.location);
    window.currentTag ? url.searchParams.set('tag', window.currentTag) : url.searchParams.delete('tag');
    q ? url.searchParams.set('q', q) : url.searchParams.delete('q');
    window.history.replaceState({}, '', url);
  }

  let visibleCount = 0;

  // Logic: Only show if a tag is active (currentTag is truthy) AND search matches
  document.querySelectorAll('.filter-item').forEach(item => {
    const tags = (item.dataset.tags || "").split(',');
    const matchesTag = (window.currentTag === 'all') || (window.currentTag && tags.includes(window.currentTag));
    const matchesSearch = item.innerText.toLowerCase().includes(qLower);

    const isVisible = !!(matchesTag && matchesSearch);
    item.classList.toggle('is-hidden', !isVisible);
    if (isVisible) visibleCount++;
  });

  // Handle No Results Message
  const noResultsEl = document.getElementById('no-results');
  if (noResultsEl) {
    noResultsEl.classList.toggle('is-hidden', visibleCount > 0);
    noResultsEl.innerText = !window.currentTag ? "Please select a tag to view items." : "No items match your criteria.";
  }

  // Sync Button UI
  document.querySelectorAll('.filter-btn').forEach(btn => {
    const btnTag = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
    btn.classList.toggle('active', btnTag === window.currentTag);
  });
};

/** 4. Reset **/
window.resetFilters = function() {
  document.getElementById('search-input').value = '';
  window.applyTagFilter('all');
};

window.toggleExtraTags = function() {
  const container = document.getElementById('extra-tag-container');
  const btn = document.getElementById('toggle-more-btn');

  if (container && btn) {
    const isHidden = container.classList.toggle('is-hidden');
    btn.innerText = isHidden ? "+ More" : "- Less";
    // Optional: add a class to style the button differently when open
    btn.classList.toggle('active-toggle', !isHidden);
  }
};
</script>
